<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Tra c·ª©u SKU / UPC / Barcode 13</title>

<script src="https://cdn.tailwindcss.com"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/fuse.js@6.6.2/dist/fuse.min.js"></script>

<!-- Barcode Scanner -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>

<style>
  .suggestions { max-height: 260px; overflow-y: auto; position: absolute; z-index: 50; width: 100%; }
  .suggestion-item:hover { background: #eef2ff; cursor: pointer; }
  .table-scroll { max-height: 500px; overflow: auto; }
  tr:hover { background-color: #f0f9ff; }
  .wrap-text { white-space: normal; word-wrap: break-word; }

  /* Camera View */
  #scanner {
    display: none;
    position: fixed;
    top: 0; left: 0;
    width: 100%; height: 100%;
    background: rgba(0,0,0,0.85);
    z-index: 9999;
    padding-top: 60px;
  }
  #scanner video { width: 100%; }
</style>
</head>
<body class="bg-slate-50 text-slate-800">

<div class="max-w-6xl mx-auto p-6">

  <header class="flex justify-between items-start mb-4">
    <h1 class="text-2xl font-semibold">Tra c·ª©u H√†ng h√≥a ‚Äî SKU / UPC / Barcode 13</h1>

    <button id="scanBtn"
      class="px-3 py-2 bg-green-600 text-white rounded-md text-sm">
      üì∑ Qu√©t m√£ v·∫°ch
    </button>
  </header>

  <!-- CAMERA SCANNER -->
  <div id="scanner">
    <button id="closeScanner"
      class="absolute top-4 right-4 bg-red-600 text-white px-4 py-2 rounded">
      ƒê√≥ng
    </button>
    <div id="scanner-container"></div>
  </div>

  <!-- SEARCH BOX -->
  <div class="bg-white p-4 rounded-lg shadow-sm relative">
    <div class="flex gap-2">
      <input id="searchBox" placeholder="Nh·∫≠p SKU / UPC / T√™n / Barcode 13..."
             class="flex-1 p-3 border rounded-md" />

      <button id="searchBtn" class="px-4 py-2 bg-blue-600 text-white rounded-md">
        T√¨m
      </button>
    </div>

    <div id="suggestions" class="suggestions bg-white border rounded-md hidden"></div>

    <p id="stats" class="mt-2 text-sm text-slate-600">ƒêang t·∫£i d·ªØ li·ªáu...</p>

    <div id="tableWrap" class="table-scroll border rounded-md mt-3"></div>
  </div>

</div>

<script>
/* ------------------- SCAN BARCODE 13 ------------------- */

function startScanner() {
  document.getElementById("scanner").style.display = "block";

  Quagga.init({
    inputStream: {
      name: "Live",
      type: "LiveStream",
      target: document.querySelector("#scanner-container"),
      constraints: { facingMode: "environment" }
    },
    decoder: { readers: ["ean_reader"] } // EAN-13
  }, function(err) {
    if (err) { console.error(err); return; }
    Quagga.start();
  });

  Quagga.onDetected(data => {
    let code = data.codeResult.code;
    if (code && code.length === 13) {
      Quagga.stop();
      document.getElementById("scanner").style.display = "none";
      searchBox.value = code;        // g√°n v√†o √¥ t√¨m ki·∫øm
      executeSearch();               // auto t√¨m
    }
  });
}

scanBtn.onclick = startScanner;
closeScanner.onclick = () => {
  Quagga.stop();
  document.getElementById("scanner").style.display = "none";
};

/* ------------------- CODE T√åM KI·∫æM G·ªêC (GI·ªÆ NGUY√äN) ------------------- */

let DATA = [], results = [], ready=false;
const normalize = s=>(s||"").toLowerCase();

/* Load Data CSV */
async function loadFromGoogleSheet(url){
  const res = await fetch(url);
  const csv = await res.text();
  const wb = XLSX.read(csv, {type:"string"});
  const sheet = wb.Sheets[wb.SheetNames[0]];
  DATA = XLSX.utils.sheet_to_json(sheet).map(r=>({
    name: String(r["T√™n"]||""), 
    sku:  String(r["SKU"]||""), 
    upc:  String(r["UPC"]||""), 
    ton:  String(r["T·ªìn"]||""), 
    gia:  String(r["Gi√°"]||""), 
    _search: normalize((r["T√™n"]+" "+r["SKU"]+" "+r["UPC"]))
  }));
  ready = true;
  stats.textContent = `ƒê√£ n·∫°p ${DATA.length} d√≤ng`;
}

loadFromGoogleSheet("YOUR_GOOGLE_SHEET_CSV_LINK");

/* Search */
function executeSearch(){
  if (!ready) return;
  const q = normalize(searchBox.value.trim());
  if (!q) return;

  results = DATA.filter(r => r._search.includes(q));
  renderResults();
}

/* Render Table */
function renderResults(){
  if (!results.length) {
    tableWrap.innerHTML = `<p class="p-3 text-sm">Kh√¥ng t√¨m th·∫•y.</p>`;
    return;
  }

  let html = `<table class="min-w-full text-sm">
  <tr><th>#</th><th>SKU</th><th>UPC</th><th>T√™n</th><th>T·ªìn</th><th>Gi√°</th></tr>`;

  results.forEach((r,i)=>{
    html += `<tr><td>${i+1}</td><td>${r.sku}</td><td>${r.upc}</td>
             <td>${r.name}</td><td>${r.ton}</td><td>${r.gia}</td></tr>`;
  });

  html += `</table>`;
  tableWrap.innerHTML = html;
}

searchBtn.onclick = executeSearch;
searchBox.onkeydown = e => { if(e.key==="Enter") executeSearch(); };

</script>
</body>
</html>
